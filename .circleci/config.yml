# # This config was automatically generated from your source code
# # Stacks detected: deps:java:android,deps:node:.,test:jest:,tool:gradle:
# version: 2.1
# orbs:
#     node: circleci/node@5
# jobs:
#     test-node:
#         # Install node dependencies and run tests
#         executor: node/default
#         environment:
#             JEST_JUNIT_OUTPUT_DIR: ./test-results/
#         steps:
#             - checkout
#             - node/install-packages:
#                   pkg-manager: npm
#             - run:
#                   command: npm install jest-junit
#             - run:
#                   name: Run tests
#                   command: npm run test --ci --runInBand --reporters=default --reporters=jest-junit
#             - store_test_results:
#                   path: ./test-results/
#     test-java:
#         docker:
#             - image: cimg/openjdk:17.0
#         working_directory: ~/project/android
#         steps:
#             - checkout:
#                   path: ~/project
#             - run:
#                   name: Calculate cache key
#                   command: |-
#                       find . -name 'pom.xml' -o -name 'gradlew*' -o -name '*.gradle*' | \
#                               sort | xargs cat > /tmp/CIRCLECI_CACHE_KEY
#             - restore_cache:
#                   key: cache-{{ checksum "/tmp/CIRCLECI_CACHE_KEY" }}
#             - run:
#                   name: chmod permissions
#                   command: chmod +x ./gradlew
#             - run:
#                   command: ./gradlew check
#             - store_test_results:
#                   path: build/test-results
#             - save_cache:
#                   key: cache-{{ checksum "/tmp/CIRCLECI_CACHE_KEY" }}
#                   paths:
#                       - ~/.gradle/caches
#             - store_artifacts:
#                   path: build/reports
#     deploy:
#         # This is an example deploy job, not actually used by the workflow
#         docker:
#             - image: cimg/base:stable
#         steps:
#             # Replace this with steps to deploy to users
#             - run:
#                   name: deploy
#                   command: '#e.g. ./deploy.sh'
# workflows:
#     build-and-test:
#         jobs:
#             - test-node
#             - test-java
#         # - deploy:
#         #     requires:
#         #       - test-node
#         #       - test-java

alpha_stage:
 
     steps:
      - checkout
      - run:
            name: configure build
            command: bundle update fastlane && gem install bundler && bundle install
            
      - run:
            name: "Install Firebase CLI"
            command: |
                  curl -sL firebase.tools | bash
      - run:
            name: "Deploy alpha build to Firebase"
            command: |
                   bundle exec fastlane stage flavor:alpha branch:${CIRCLE_BRANCH} app_id:$FIREBASE_APP_ID_ALPHA firebase_token:$FIREBASE_TOKEN

  workflows:
  version: 2
  build_tests_deploy:
    jobs:
       - build
       - test:
            requires:
               - build
       - alpha_stage:
            requires:
               - build
       - delta_stage:
            requires:
               - build
       - prod_stage:
            requires:
               - build
       - prod:
            filters:
             branches:
                only:
                   - master
                   - develop
            requires:
               - test
      - deploy:
            filters:
             branches:
                only:
                   - master
            requires:
               - prod